- is_my_profile = (user_signed_in? and @user_profile == current_user.user_profile)
- is_private = !(@user_profile.publicly_viewable or (user_signed_in? and @user_profile.id == current_user.user_profile_id))
- title "Profile: #{@user_profile.display_name}"
- content_for :header do
  = stylesheet_link_tag "top_level/user_profiles"
  = javascript_include_tag "user_profiles"
  = javascript_include_tag "activities"

#body{ class: is_my_profile ? 'myprofile' : '' }
  %header
    %h1= shorten_words @user_profile.display_name.to_s, 21
    - if @user_profile.title?
      %p= @user_profile.title
  %aside
    .avatar= image_tag @user_profile.avatar_url :large
    .actions
      - if can? :update, @user_profile
        = link_to "Settings", edit_user_registration_url(subdomain: "secure", protocol: (Rails.env.development? ? "http://" : "https://")), class: 'settings'
        = link_to 'Edit Profile', edit_user_profile_url(@user_profile), class: 'edit'
      - elsif user_signed_in?
        - if current_user.address_book.include? @user_profile
          = link_to 'Message', compose_mail_to_url(@user_profile), class: 'message'
        - if @communities_to_invite_to.any?
          .recruit
            Recruit to&hellip;
            %ul
              - @communities_to_invite_to.each do |community|
                %li= link_to community.name, community_invites_url(community_invite: {applicant_id: @user_profile.id, community_id: community.id, sponsor_id: current_user.user_profile_id}), method: :post
    - if @user_profile.publicly_viewable or is_my_profile
      %h3 My Communities
      - if @user_profile.communities.any?
        %ul.communities
          - @user_profile.communities.includes(:admin_profile).each do |community|
            %li= link_to shorten_words(community.name), root_url(subdomain: community.subdomain)
      - elsif is_my_profile
        %p
          You don't have any memberships yet.
          = link_to 'Find a community ›', search_url
          %br
          = link_to 'Create a community ›', new_community_url
      - else
        %p
          This user is not a member of any communities.
      - unless @user_profile.location.to_s.strip == ''
        %h3 Location
        %p= shorten_words @user_profile.location
      - unless @user_profile.description.to_s.strip == ''
        %h3 About Me
        %p= shorten_words @user_profile.description
      %h3 Stats
      %p.stats
        = "User since #{l @user_profile.created_at, format: :date_short}."
        %br
        = pluralize(Discussion.where(user_profile_id: @user_profile.id).size, 'discussion') + ' created.'
        %br
        = pluralize(Comment.where(user_profile_id: @user_profile.id).size, 'comment') + ' made.'
  %article
    - if !is_private or @communities_with_roles_to_assign.any?
      %dl#tabs.tabs
        - if @user_profile.communities.any?
          - if @communities_with_roles_to_assign.any? or is_my_profile
            %dt{ class: 'roles' }
              = link_to 'User Roles', roles_user_profile_url(@user_profile, subdomain: false, format: :js), remote: true, class: 'dynload wait', data: { type: :text, target: '#tabs dt.roles + dd', error: 'Error: unable to load user roles.' }
            %dd
          - if is_my_profile
            %dt{ class: 'invites' }
              = link_to 'Invites', invites_user_profile_url(@user_profile, subdomain: false, format: :js), remote: true, class: 'dynload wait', data: { type: :text, target: '#tabs dt.invites + dd', error: 'Error: unable to load invites.' }
            %dd
            %dt{ class: 'announcements' }
              = link_to 'Announcements', announcements_user_profile_url(@user_profile, subdomain: false, format: :js), remote: true, class: 'dynload wait', data: { type: :text, target: '#tabs dt.announcements + dd', error: 'Error: unable to load announcements.' }
            %dd
        - unless is_private
          %dt{ class: 'characters' }
            = link_to 'Characters', characters_user_profile_url(@user_profile, subdomain: false, format: :js), remote: true, class: 'dynload wait', data: { type: :text, target: '#tabs dt.characters + dd', error: 'Error: unable to load characters.' }
          %dd
          %dt{ class: 'activities current' }
            = link_to 'Recent Activity', activities_user_profile_url(@user_profile, subdomain: false, format: :js), remote: true, class: 'dynload wait', data: { type: :text, target: '#tabs dt.activities + dd', error: 'Error: unable to load recent activity.' }
          %dd
    - else
      %p This user's profile is private.